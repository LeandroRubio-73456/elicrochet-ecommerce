name: CI Quality Gate EliCrochet

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

permissions:
  contents: read

jobs:
  laravel-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, sqlite3
          coverage: pcov
          cache: 'composer' # Cache automático de dependencias de Composer

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm' # Cache automático de node_modules

      - name: Install Dependencies
        run: |
          composer install --prefer-dist --no-progress
          npm ci

      - name: Prepare Environment
        run: |
          cp .env.example .env
          php artisan key:generate
          touch database/database.sqlite

      - name: Check Code Style
        run: vendor/bin/pint --test

      - name: Build assets
        run: npm run build

      - name: Run Tests with Coverage
        run: php artisan test --coverage-clover=coverage.xml --log-junit=test-report.xml --min=60

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@383f7e52eae3ab0510c3cb0e7d9d150bbaeab838 # v3.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub lo pone solo
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    # Este es el que creamos
        with:
          args: >
            -Dsonar.projectKey=LeandroRubio-73456_elicrochet-ecommerce
            -Dsonar.organization=leandrorubio-73456

      - name: Static Analysis
        run: php artisan insights --min-quality=80 --no-interaction

      # Guardamos el build para que Lighthouse no tenga que volver a compilar
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-assets
          path: public/build

  lighthouse:
    needs: laravel-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: sqlite3
          cache: 'composer'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          path: public/build

      - name: Install Dependencies
        run: |
          composer install --prefer-dist --no-progress
          npm ci

      - name: Prepare Environment
        run: |
          cp .env.example .env
          php artisan key:generate
          touch database/database.sqlite
          php artisan migrate --force

      - name: Run Lighthouse CI
        run: |
          npm run lhci:mobile
          npm run lhci:desktop

  analyze:
    name: Security Analysis (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write # Permiso crucial para publicar resultados en la pestaña de Seguridad

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ] # CodeQL native support for JS/TS only

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Inicializa las herramientas de CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql/codeql-config.yml
          # Puedes añadir consultas personalizadas aquí si lo deseas
          queries: security-extended,security-and-quality 

      # CodeQL intenta compilar automáticamente (en PHP/JS es muy rápido)
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      # Ejecuta el análisis semántico
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  php-security:
    name: Security Analysis (Psalm)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Psalm Security Scan
        uses: docker://ghcr.io/psalm/psalm-security-scan:latest
        with:
          security_analysis_result_path: "results.sarif"

      - name: Upload Security Bundle
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: php-security